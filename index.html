<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语发音练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3; /*f7fbf3  3f4040*/
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #feeec9; /*041b31 1f4263*/
            background: #fede94; /*ecf2e4 fefefc fede94 */
            color: #5b5b5b; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #feeec9; 
            background: #fede94; 
            color: #6b6b6b; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #feeec9; 
            background: #fede94; 
            color: #6b6b6b; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #f7fbf3;
                        border: 3px solid #f7fbf3;                        
            padding: 10px 0; 
           /* box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); */
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 2px solid #fede94; 
            background: #fede94; /*192332*/
                        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #5b5b5b; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #fede94; /*041b31 68838B*/
            background: #f8e5ba; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 3px solid #b6d7a8; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #fed16a; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ffffff;
            background: #ffffff; /*E6EDD9*/
            color: #000000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 45px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 30px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力-发音</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 1.29,
        "end": 2.13,
        "correctAnswer": "bơm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bơm",
            "mơm",
            "bơn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 2.81,
        "end": 3.67,
        "correctAnswer": "bám",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bám",
            "mám",
            "pám"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.43,
        "end": 5.13,
        "correctAnswer": "bõm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bõm",
            "bom",
            "mõm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 5.92,
        "end": 6.81,
        "correctAnswer": "móm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "móm",
            "bóm",
            "món"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 7.61,
        "end": 8.55,
        "correctAnswer": "bỉm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bỉm",
            "bỉ",
            "bỉn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 9.2,
        "end": 10.16,
        "correctAnswer": "mĩm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mĩm",
            "mĩn",
            "mĩ"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 10.92,
        "end": 11.94,
        "correctAnswer": "mềm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mềm",
            "mền",
            "mêm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 12.72,
        "end": 13.69,
        "correctAnswer": "mồm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mồm",
            "mồn",
            "mỗm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 14.6,
        "end": 15.6,
        "correctAnswer": "nếm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nếm",
            "nến",
            "mếm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 16.44,
        "end": 17.46,
        "correctAnswer": "lem",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "lem",
            "len",
            "nem"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 18.28,
        "end": 19.3,
        "correctAnswer": "nem",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nem",
            "lem",
            "nêm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 20.22,
        "end": 21.2,
        "correctAnswer": "nồm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nồm",
            "lồm",
            "nòm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 22.11,
        "end": 23.07,
        "correctAnswer": "nom",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nom",
            "lom",
            "nơm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 23.91,
        "end": 24.72,
        "correctAnswer": "lõm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "lõm",
            "lỗm",
            "nỗm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 25.78,
        "end": 26.54,
        "correctAnswer": "lịm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "lịm",
            "lịn",
            "lìm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.68,
        "end": 28.47,
        "correctAnswer": "nạm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nạm",
            "nàm",
            "lạm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 29.6,
        "end": 30.5,
        "correctAnswer": "làm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "làm",
            "làn",
            "nàm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 31.55,
        "end": 32.45,
        "correctAnswer": "thêm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thêm",
            "thê",
            "them"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 33.62,
        "end": 34.53,
        "correctAnswer": "tem",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tem",
            "têm",
            "tim"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 35.51,
        "end": 36.38,
        "correctAnswer": "thơm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thơm",
            "thơn",
            "tơm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 37.36,
        "end": 38.25,
        "correctAnswer": "tam",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tàm",
            "tám",
            "tham",
            "tam",
            "tan"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 39.4,
        "end": 40.29,
        "correctAnswer": "tim",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tin",
            "tim",
            "thím"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.19,
        "end": 42.17,
        "correctAnswer": "thím",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thín",
            "thím",
            "tín"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 42.85,
        "end": 43.73,
        "correctAnswer": "thèm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thèm",
            "tèm",
            "thèng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 44.66,
        "end": 45.38,
        "correctAnswer": "tởm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tởm",
            "tổm",
            "tỏm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 46.46,
        "end": 47.3,
        "correctAnswer": "tám",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tạm",
            "tám",
            "tãm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 48.36,
        "end": 49.2,
        "correctAnswer": "túm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "túm",
            "tốm",
            "tóm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 50.19,
        "end": 51.11,
        "correctAnswer": "tôm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tôm",
            "thôm",
            "tô"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 51.92,
        "end": 52.9,
        "correctAnswer": "xem",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xem",
            "xêm",
            "xom"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 53.78,
        "end": 54.61,
        "correctAnswer": "xàm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xàm",
            "xám",
            "xạm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 55.46,
        "end": 56.46,
        "correctAnswer": "sum",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "sum",
            "sun",
            "sung"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 57.26,
        "end": 58.24,
        "correctAnswer": "xúm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xúm",
            "sụm",
            "sún"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 59.07,
        "end": 59.97,
        "correctAnswer": "xóm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xóm",
            "sọm",
            "sòm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 60.83,
        "end": 61.7,
        "correctAnswer": "dám",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "dám",
            "dáng",
            "dán"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 62.57,
        "end": 63.42,
        "correctAnswer": "rèm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rèm",
            "rèn",
            "rềm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 64.33,
        "end": 65.2,
        "correctAnswer": "giám",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "giám",
            "dáng",
            "dàn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 66.08,
        "end": 66.98,
        "correctAnswer": "rơm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rơm",
            "rớm",
            "róm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 67.9,
        "end": 68.83,
        "correctAnswer": "kim",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "kim",
            "cim",
            "kêm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 69.7,
        "end": 70.63,
        "correctAnswer": "kem",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "kem",
            "cen",
            "cem"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 71.6,
        "end": 72.53,
        "correctAnswer": "cơm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "cơm",
            "kơm",
            "cơn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 73.27,
        "end": 74.12,
        "correctAnswer": "khám",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "khám",
            "khãm",
            "kháng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 74.96,
        "end": 75.83,
        "correctAnswer": "khúm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "khúm",
            "khún",
            "húm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 76.64,
        "end": 77.43,
        "correctAnswer": "hãm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hãm",
            "hãn",
            "hãng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 78.25,
        "end": 79.11,
        "correctAnswer": "hùm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hùm",
            "khùm",
            "kùm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 80.47,
        "end": 81.29,
        "correctAnswer": "khóm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "khóm",
            "hóm",
            "kóm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 82.11,
        "end": 82.88,
        "correctAnswer": "hõm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hõm",
            "khõm",
            "hõn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 83.75,
        "end": 84.59,
        "correctAnswer": "khem",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "khem",
            "kheng",
            "khen"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 85.38,
        "end": 86.08,
        "correctAnswer": "hẻm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hẻm",
            "hẹn",
            "hẽn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 87.16,
        "end": 88.01,
        "correctAnswer": "hôm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hôm",
            "hôn",
            "hom"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 88.82,
        "end": 89.66,
        "correctAnswer": "hòm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hom",
            "hòm",
            "hôm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 90.7,
        "end": 91.56,
        "correctAnswer": "cam",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "kam",
            "cam",
            "can"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 92.35,
        "end": 93.08,
        "correctAnswer": "cúm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "cúm",
            "cùm",
            "cụm"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 93.98,
        "end": 94.68,
        "correctAnswer": "cọm",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "cọm",
            "cọn",
            "cọng"
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #2f2f2f;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>